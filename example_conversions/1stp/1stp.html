<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Final//EN">
<!-- vi: sw=2:
-->
<html>
  <head>
    <title>Simple Chimera Viewer</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <script type="text/javascript" src="http://www.cgl.ucsf.edu/chimera/webgl/PhiloGL-1.3.0.js"></script>
  </head>

  <body onload="webGLStart();">
    <div id="fallback" class="fallback"></div>
    <canvas id="molview" width="830" height="551"></canvas>

    <script>
      if (!PhiloGL.hasWebGL()) {
	document.body.className = 'no-webgl';
	document.getElementById('fallback').innerHTML = ''
	+ '<div style="margin:10px;">'
	+ 'Your web browser does not support or is not configured for WebGL.'
	+ '  See <a href="http://get.webgl.org/">WebGL Support</a>'
	+ ' for more information.'
	+ '</div>';
      }
    </script>
  </body>
</html>
<script id="default.fs" type="x-shader/x-fragment">
#ifdef GL_ES
precision highp float;
#endif

varying vec4 vColor;
varying vec2 vTexCoord;
varying vec3 lightWeighting;

uniform bool hasTexture1;
uniform sampler2D sampler1;

uniform bool enablePicking;
uniform vec3 pickColor;

uniform bool hasFog;
uniform vec3 fogColor;

uniform float fogNear;
uniform float fogFar;

void main(){
  
  if(!hasTexture1) {
    gl_FragColor = vec4(vColor.rgb * lightWeighting, vColor.a);
  } else {
    gl_FragColor = vec4(texture2D(sampler1, vec2(vTexCoord.s, vTexCoord.t)).rgb * lightWeighting, 1.0);
  }

  if(enablePicking) {
    gl_FragColor = vec4(pickColor, 1.0);
  }
  
  /* handle fog */
  if (hasFog) {
    float depth = gl_FragCoord.z / gl_FragCoord.w;
    float fogFactor = smoothstep(fogNear, fogFar, depth);
    gl_FragColor = mix(gl_FragColor, vec4(fogColor, gl_FragColor.w), fogFactor);
  }  

}
</script>
<script id="offset.vs" type="x-shader/x-vertex">
// just like default.vs.glsl expect for additional offset
#define LIGHT_MAX 8

attribute vec3 position;
attribute vec3 offset;
attribute vec3 normal;
attribute vec4 color;
attribute vec2 texCoord1;

uniform mat4 worldMatrix;
uniform mat4 viewMatrix;
uniform mat4 projectionMatrix;
uniform mat4 worldInverseTransposeMatrix;

uniform bool enableLights;
uniform vec3 ambientColor;
uniform vec3 directionalColor;
uniform vec3 lightingDirection;

uniform vec3 pointLocation[LIGHT_MAX];
uniform vec3 pointColor[LIGHT_MAX];
uniform int numberPoints;

varying vec4 vColor;
varying vec2 vTexCoord;
varying vec3 lightWeighting;

void main(void) {
  vec4 mvPosition = worldMatrix * vec4(position + offset, 1.0);
  
  if(!enableLights) {
    lightWeighting = vec3(1.0, 1.0, 1.0);
  } else {
    vec3 plightDirection;
    vec3 pointWeight = vec3(0.0, 0.0, 0.0);
    vec4 transformedNormal = worldInverseTransposeMatrix * vec4(normal, 1.0);
    float directionalLightWeighting = max(dot(transformedNormal.xyz, lightingDirection), 0.0);
    for (int i = 0; i < LIGHT_MAX; i++) {
      if (i < numberPoints) {
        plightDirection = normalize((viewMatrix * vec4(pointLocation[i], 1.0)).xyz - mvPosition.xyz);
        pointWeight += max(dot(transformedNormal.xyz, plightDirection), 0.0) * pointColor[i];
      } else {
        break;
      }
    }

    lightWeighting = ambientColor + (directionalColor * directionalLightWeighting) + pointWeight;
  }
  
  vColor = color;
  vTexCoord = texCoord1;
  gl_Position = projectionMatrix * mvPosition;
}
</script>
<script id="cylinder.vs" type="x-shader/x-vertex">
// just like default.vs.glsl expect for additional tranformation
#define LIGHT_MAX 8

attribute vec3 position;
attribute vec4 transformX, transformY, transformZ;	// 4x3 transformation
attribute float yscale;
attribute vec3 normal;
attribute vec4 color;
attribute vec2 texCoord1;

uniform mat4 worldMatrix;
uniform mat4 viewMatrix;
uniform mat4 projectionMatrix;
uniform mat4 worldInverseTransposeMatrix;

uniform bool enableLights;
uniform vec3 ambientColor;
uniform vec3 directionalColor;
uniform vec3 lightingDirection;

uniform vec3 pointLocation[LIGHT_MAX];
uniform vec3 pointColor[LIGHT_MAX];
uniform int numberPoints;

varying vec4 vColor;
varying vec2 vTexCoord;
varying vec3 lightWeighting;

void main(void) {
  vec4 pos = vec4(position * vec3(1.0, yscale, 1.0), 1.0);
  vec4 mvPosition;
  mvPosition.x = dot(pos, transformX);
  mvPosition.y = dot(pos, transformY);
  mvPosition.z = dot(pos, transformZ);
  mvPosition.w = pos.w;
  pos = worldMatrix * mvPosition;
  mvPosition = pos;
  vec3 n;
  n.x = dot(normal, vec3(transformX));
  n.y = dot(normal, vec3(transformY));
  n.z = dot(normal, vec3(transformZ));
  
  if(!enableLights) {
    lightWeighting = vec3(1.0, 1.0, 1.0);
  } else {
    vec3 plightDirection;
    vec3 pointWeight = vec3(0.0, 0.0, 0.0);
    //vec3 transformedNormal = mat3(worldInverseTransposeMatrix) * n;
    vec3 transformedNormal = vec3(worldInverseTransposeMatrix * vec4(n, 0.0));
    float directionalLightWeighting = max(dot(transformedNormal, lightingDirection), 0.0);
    for (int i = 0; i < LIGHT_MAX; i++) {
      if (i < numberPoints) {
        plightDirection = normalize((viewMatrix * vec4(pointLocation[i], 1.0)).xyz - mvPosition.xyz);
        pointWeight += max(dot(transformedNormal, plightDirection), 0.0) * pointColor[i];
      } else {
        break;
      }
    }

    lightWeighting = ambientColor + (directionalColor * directionalLightWeighting) + pointWeight;
  }
  
  vColor = color;
  vTexCoord = texCoord1;
  gl_Position = projectionMatrix * mvPosition;
}
</script>
<script id="nolight.vs" type="x-shader/x-vertex">
// just like default.vs.glsl except all lights are ignored
#define LIGHT_MAX 8

attribute vec3 position;
attribute vec3 normal;
attribute vec4 color;
attribute vec2 texCoord1;

uniform mat4 worldMatrix;
uniform mat4 viewMatrix;
uniform mat4 projectionMatrix;
uniform mat4 worldInverseTransposeMatrix;

uniform bool enableLights;
uniform vec3 ambientColor;
uniform vec3 directionalColor;
uniform vec3 lightingDirection;

uniform vec3 pointLocation[LIGHT_MAX];
uniform vec3 pointColor[LIGHT_MAX];
uniform int numberPoints;

varying vec4 vColor;
varying vec2 vTexCoord;
varying vec3 lightWeighting;

void main(void) {
  vec4 mvPosition = worldMatrix * vec4(position, 1.0);
  
  lightWeighting = vec3(1.0, 1.0, 1.0);
  
  vColor = color;
  vTexCoord = texCoord1;
  gl_Position = projectionMatrix * mvPosition;
}
</script>
<script>
var json = 
[
["bg",0.0,0.0,0.0],
["cofr",9.973,4.259,-0.43],
["eyepos",9.973,4.259,147.735],
["up",0,1,0],
["persp",15.011],
["ld",0.746,0.746,0.746,0.357,-0.66,-0.66],
["ld",0.432,0.432,0.432,-0.251,-0.251,-0.935],
["la",0.197,0.197,0.197],
["t",[-21.04,-9.443,-18.241,-19.447,-13.775,-18.879,-22.601,-5.803,-23.122,-22.666,-11.9,-21.996,-17.98,-16.401,-31.17,-17.093,-18.054,-24.166,-22.53,-15.099,-27.458,-22.806,-5.427,-27.126,-21.752,-11.004,-32.507,-21.795,-6.961,-31.773,-23.981,-9.607,-29.389,-11.773,-10.52,-12.509,-9.271,-15.909,-14.844,-15.314,-14.711,-17.093,-9.196,-21.061,-26.887,-7.987,-20.496,-19.255,-13.75,-19.636,-22.43,-17.143,2.638,-6.131,-13.969,-2.425,-6.792,-17.783,3.499,-11.74,-19.487,-1.189,-8.4,-12.798,2.616,-9.315,-14.079,-6.586,-10.346,-17.085,0.088,-18.904,-18.875,-5.07,-14.513,-9.231,-17.515,-35.125,-10.807,-19.62,-30.75,-10.915,-12.612,-36.056,-13.858,-16.209,-33.928,-16.553,-0.817,-24.585,-17.525,-2.11,-27.423,-19.687,-2.482,-24.714,-14.365,-0.878,-26.903,-15.824,-8.833,-34.132,-15.62,-4.156,-32.985,-0.752,-13.032,-12.336,1.3,-16.34,-13.874,-3.444,-16.217,-13.851,2.308,-14.211,-13.526,2.216,-21.087,-18.475,-3.839,-22.018,-20.997,3.447,-23.499,-27.19,2.281,-23.685,-24.515,0.239,-23.447,-26.634,-5.798,-4.217,-9.798,-3.52,-7.222,-10.25,-8.843,-7.758,-10.451,-2.824,-3.186,-12.358,-0.028,-20.578,-33.173,-6.434,-21.209,-29.61,-8.442,-0.335,-12.415,-9.569,1.508,-16.207,-5.56,0.396,-16.162,-10.225,0.255,-24.123,-3.003,-14.915,-37.722,-4.635,-8.376,-38.203,-7.678,-0.016,-29.889,-8.911,-5.06,-35.591,-9.486,-1.314,-33.101,7.46,-13.376,-16.672,8.446,-18.235,-19.252,11.738,-15.077,-20.734,9.414,-20.343,-29.375,8.597,-22.048,-24.693,13.806,-17.596,-25.693,2.009,-5.222,-14.211,5.541,-10.122,-15.086,7.13,-3.402,-19.056,5.959,-16.982,-35.076,0.417,-0.573,-19.304,-2.436,0.873,-23.274,2.86,0.394,-23.185,3.971,-11.364,-38.696,2.033,-4.193,-39.442,-0.135,2.572,-29.866,-1.528,-2.547,-38.24,-1.959,2.22,-34.934,10.805,-5.448,-20.093,14.332,-11.201,-22.47,12.074,-12.294,-33.262,14.962,-14.247,-28.523,15.102,-9.249,-31.077,8.962,0.644,-25.675,14.166,0.114,-30.843,9.375,-7.065,-38.218,7.747,-1.487,-38.664,12.257,-4.492,-35.569,6.478,3.801,-32.269,4.884,1.405,-37.422,4.416,4.137,-34.427,7.91,2.869,-34.797,17.144,-3.11,-23.925,18.863,-4.704,-28.546,19.025,-7.26,-25.475,16.665,-0.136,-28.466,20.578,-3.073,-26.366,-21.04,-9.443,-18.241,-19.447,-13.775,-18.879,-22.601,-5.803,-23.122,-22.666,-11.9,-21.996,-17.98,-16.401,-31.17,-17.093,-18.054,-24.166,-22.53,-15.099,-27.458,-22.806,-5.427,-27.126,-21.752,-11.004,-32.507,-21.795,-6.961,-31.773,-23.981,-9.607,-29.389,-11.773,-10.52,-12.509,-9.271,-15.909,-14.844,-15.314,-14.711,-17.093,-9.196,-21.061,-26.887,-7.987,-20.496,-19.255,-13.75,-19.636,-22.43,-17.143,2.638,-6.131,-13.969,-2.425,-6.792,-17.783,3.499,-11.74,-19.487,-1.189,-8.4,-12.798,2.616,-9.315,-14.079,-6.586,-10.346,-17.085,0.088,-18.904,-18.875,-5.07,-14.513,-9.231,-17.515,-35.125,-10.807,-19.62,-30.75,-10.915,-12.612,-36.056,-13.858,-16.209,-33.928,-16.553,-0.817,-24.585,-17.525,-2.11,-27.423,-19.687,-2.482,-24.714,-14.365,-0.878,-26.903,-15.824,-8.833,-34.132,-15.62,-4.156,-32.985,-0.752,-13.032,-12.336,1.3,-16.34,-13.874,-3.444,-16.217,-13.851,2.308,-14.211,-13.526,2.216,-21.087,-18.475,-3.839,-22.018,-20.997,3.447,-23.499,-27.19,2.281,-23.685,-24.515,0.239,-23.447,-26.634,-5.798,-4.217,-9.798,-3.52,-7.222,-10.25,-8.843,-7.758,-10.451,-2.824,-3.186,-12.358,-0.028,-20.578,-33.173,-6.434,-21.209,-29.61,-8.442,-0.335,-12.415,-9.569,1.508,-16.207,-5.56,0.396,-16.162,-10.225,0.255,-24.123,-3.003,-14.915,-37.722,-4.635,-8.376,-38.203,-7.678,-0.016,-29.889,-8.911,-5.06,-35.591,-9.486,-1.314,-33.101,7.46,-13.376,-16.672,8.446,-18.235,-19.252,11.738,-15.077,-20.734,9.414,-20.343,-29.375,8.597,-22.048,-24.693,13.806,-17.596,-25.693,2.009,-5.222,-14.211,5.541,-10.122,-15.086,7.13,-3.402,-19.056,5.959,-16.982,-35.076,0.417,-0.573,-19.304,-2.436,0.873,-23.274,2.86,0.394,-23.185,3.971,-11.364,-38.696,2.033,-4.193,-39.442,-0.135,2.572,-29.866,-1.528,-2.547,-38.24,-1.959,2.22,-34.934,10.805,-5.448,-20.093,14.332,-11.201,-22.47,12.074,-12.294,-33.262,14.962,-14.247,-28.523,15.102,-9.249,-31.077,8.962,0.644,-25.675,14.166,0.114,-30.843,9.375,-7.065,-38.218,7.747,-1.487,-38.664,12.257,-4.492,-35.569,6.478,3.801,-32.269,4.884,1.405,-37.422,4.416,4.137,-34.427,7.91,2.869,-34.797,17.144,-3.11,-23.925,18.863,-4.704,-28.546,19.025,-7.26,-25.475,16.665,-0.136,-28.466,20.578,-3.073,-26.366,-21.04,-9.443,-18.241,-19.447,-13.775,-18.879,-22.601,-5.803,-23.122,-22.666,-11.9,-21.996,-17.98,-16.401,-31.17,-17.093,-18.054,-24.166,-22.53,-15.099,-27.458,-22.806,-5.427,-27.126,-21.752,-11.004,-32.507,-21.795,-6.961,-31.773,-23.981,-9.607,-29.389,-11.773,-10.52,-12.509,-9.271,-15.909,-14.844,-15.314,-14.711,-17.093,-9.196,-21.061,-26.887,-7.987,-20.496,-19.255,-13.75,-19.636,-22.43,-17.143,2.638,-6.131,-13.969,-2.425,-6.792,-17.783,3.499,-11.74,-19.487,-1.189,-8.4,-12.798,2.616,-9.315,-14.079,-6.586,-10.346,-17.085,0.088,-18.904,-18.875,-5.07,-14.513,-9.231,-17.515,-35.125,-10.807,-19.62,-30.75,-10.915,-12.612,-36.056,-13.858,-16.209,-33.928,-16.553,-0.817,-24.585,-17.525,-2.11,-27.423,-19.687,-2.482,-24.714,-14.365,-0.878,-26.903,-15.824,-8.833,-34.132,-15.62,-4.156,-32.985,-0.752,-13.032,-12.336,1.3,-16.34,-13.874,-3.444,-16.217,-13.851,2.308,-14.211,-13.526,2.216,-21.087,-18.475,-3.839,-22.018,-20.997,3.447,-23.499,-27.19,2.281,-23.685,-24.515,0.239,-23.447,-26.634,-5.798,-4.217,-9.798,-3.52,-7.222,-10.25,-8.843,-7.758,-10.451,-2.824,-3.186,-12.358,-0.028,-20.578,-33.173,-6.434,-21.209,-29.61,-8.442,-0.335,-12.415,-9.569,1.508,-16.207,-5.56,0.396,-16.162,-10.225,0.255,-24.123,-3.003,-14.915,-37.722,-4.635,-8.376,-38.203,-7.678,-0.016,-29.889,-8.911,-5.06,-35.591,-9.486,-1.314,-33.101,7.46,-13.376,-16.672,8.446,-18.235,-19.252,11.738,-15.077,-20.734,9.414,-20.343,-29.375,8.597,-22.048,-24.693,13.806,-17.596,-25.693,2.009,-5.222,-14.211,5.541,-10.122,-15.086,7.13,-3.402,-19.056,5.959,-16.982,-35.076,0.417,-0.573,-19.304,-2.436,0.873,-23.274,2.86,0.394,-23.185,3.971,-11.364,-38.696,2.033,-4.193,-39.442,-0.135,2.572,-29.866,-1.528,-2.547,-38.24,-1.959,2.22,-34.934,10.805,-5.448,-20.093,14.332,-11.201,-22.47,12.074,-12.294,-33.262,14.962,-14.247,-28.523,15.102,-9.249,-31.077,8.962,0.644,-25.675,14.166,0.114,-30.843,9.375,-7.065,-38.218,7.747,-1.487,-38.664,12.257,-4.492,-35.569,6.478,3.801,-32.269,4.884,1.405,-37.422,4.416,4.137,-34.427,7.91,2.869,-34.797,17.144,-3.11,-23.925,18.863,-4.704,-28.546,19.025,-7.26,-25.475,16.665,-0.136,-28.466,20.578,-3.073,-26.366],[-0.835,-0.175,0.521,-0.697,-0.431,0.573,-0.902,0.415,0.123,-0.904,-0.22,0.368,-0.56,-0.673,-0.483,-0.565,-0.808,0.168,-0.853,-0.51,-0.109,-0.788,0.579,-0.211,-0.738,0.04,-0.673,-0.681,0.421,-0.599,-0.911,0.168,-0.376,-0.325,-0.534,0.78,-0.282,-0.583,0.762,-0.498,-0.583,0.642,-0.329,-0.939,-0.1,-0.221,-0.857,0.465,-0.406,-0.871,0.277,-0.115,0.537,0.836,0.138,-0.194,0.971,-0.353,0.936,-0.019,-0.763,-0.162,0.625,0.392,0.763,0.514,-0.368,-0.51,0.778,-0.482,0.847,-0.225,-0.879,-0.105,0.465,-0.284,-0.608,-0.742,-0.368,-0.833,-0.414,-0.371,-0.253,-0.893,-0.38,-0.559,-0.737,-0.297,0.914,-0.278,-0.389,0.849,-0.358,-0.514,0.834,-0.199,-0.284,0.909,-0.305,-0.45,0.261,-0.854,-0.407,0.611,-0.679,0.224,-0.301,0.927,0.27,-0.472,0.839,0.05,-0.564,0.825,0.339,-0.328,0.882,0.232,-0.799,0.554,-0.076,-0.934,0.348,0.096,-0.994,-0.049,0.064,-0.989,0.137,-0.034,-0.999,-0.031,0.177,0.369,0.913,0.173,0.17,0.97,-0.047,-0.283,0.958,0.265,0.598,0.757,0.02,-0.814,-0.58,-0.251,-0.915,-0.316,0.33,0.781,0.53,0.161,0.974,0.159,0.261,0.911,0.319,-0.141,0.98,-0.143,-0.139,-0.395,-0.908,-0.363,0.063,-0.93,-0.326,0.892,-0.314,-0.472,0.453,-0.757,-0.438,0.726,-0.531,0.575,-0.22,0.788,0.584,-0.517,0.626,0.713,-0.325,0.621,0.517,-0.821,-0.242,0.433,-0.886,0.165,0.873,-0.462,0.154,0.42,0.51,0.75,0.533,0.07,0.843,0.47,0.646,0.602,0.382,-0.586,-0.715,0.279,0.889,0.362,0.088,0.986,0.143,0.198,0.936,0.291,0.177,-0.264,-0.948,-0.113,0.239,-0.964,-0.153,0.988,-0.036,-0.336,0.429,-0.838,-0.305,0.847,-0.435,0.623,0.392,0.677,0.819,-0.166,0.55,0.752,-0.285,-0.594,0.93,-0.307,-0.201,0.884,-0.098,-0.457,0.347,0.883,0.317,0.615,0.715,-0.331,0.583,-0.049,-0.811,0.393,0.396,-0.83,0.747,0.146,-0.648,0.175,0.971,-0.163,0.098,0.766,-0.636,0.069,0.955,-0.287,0.296,0.869,-0.396,0.845,0.381,0.375,0.968,0.131,-0.213,0.986,-0.079,0.145,0.723,0.673,-0.152,0.968,0.248,0.041,-0.835,-0.175,0.521,-0.697,-0.431,0.573,-0.902,0.415,0.123,-0.904,-0.22,0.368,-0.56,-0.673,-0.483,-0.565,-0.808,0.168,-0.853,-0.51,-0.109,-0.788,0.579,-0.211,-0.738,0.04,-0.673,-0.681,0.421,-0.599,-0.911,0.168,-0.376,-0.325,-0.534,0.78,-0.282,-0.583,0.762,-0.498,-0.583,0.642,-0.329,-0.939,-0.1,-0.221,-0.857,0.465,-0.406,-0.871,0.277,-0.115,0.537,0.836,0.138,-0.194,0.971,-0.353,0.936,-0.019,-0.763,-0.162,0.625,0.392,0.763,0.514,-0.368,-0.51,0.778,-0.482,0.847,-0.225,-0.879,-0.105,0.465,-0.284,-0.608,-0.742,-0.368,-0.833,-0.414,-0.371,-0.253,-0.893,-0.38,-0.559,-0.737,-0.297,0.914,-0.278,-0.389,0.849,-0.358,-0.514,0.834,-0.199,-0.284,0.909,-0.305,-0.45,0.261,-0.854,-0.407,0.611,-0.679,0.224,-0.301,0.927,0.27,-0.472,0.839,0.05,-0.564,0.825,0.339,-0.328,0.882,0.232,-0.799,0.554,-0.076,-0.934,0.348,0.096,-0.994,-0.049,0.064,-0.989,0.137,-0.034,-0.999,-0.031,0.177,0.369,0.913,0.173,0.17,0.97,-0.047,-0.283,0.958,0.265,0.598,0.757,0.02,-0.814,-0.58,-0.251,-0.915,-0.316,0.33,0.781,0.53,0.161,0.974,0.159,0.261,0.911,0.319,-0.141,0.98,-0.143,-0.139,-0.395,-0.908,-0.363,0.063,-0.93,-0.326,0.892,-0.314,-0.472,0.453,-0.757,-0.438,0.726,-0.531,0.575,-0.22,0.788,0.584,-0.517,0.626,0.713,-0.325,0.621,0.517,-0.821,-0.242,0.433,-0.886,0.165,0.873,-0.462,0.154,0.42,0.51,0.75,0.533,0.07,0.843,0.47,0.646,0.602,0.382,-0.586,-0.715,0.279,0.889,0.362,0.088,0.986,0.143,0.198,0.936,0.291,0.177,-0.264,-0.948,-0.113,0.239,-0.964,-0.153,0.988,-0.036,-0.336,0.429,-0.838,-0.305,0.847,-0.435,0.623,0.392,0.677,0.819,-0.166,0.55,0.752,-0.285,-0.594,0.93,-0.307,-0.201,0.884,-0.098,-0.457,0.347,0.883,0.317,0.615,0.715,-0.331,0.583,-0.049,-0.811,0.393,0.396,-0.83,0.747,0.146,-0.648,0.175,0.971,-0.163,0.098,0.766,-0.636,0.069,0.955,-0.287,0.296,0.869,-0.396,0.845,0.381,0.375,0.968,0.131,-0.213,0.986,-0.079,0.145,0.723,0.673,-0.152,0.968,0.248,0.041,-0.835,-0.175,0.521,-0.697,-0.431,0.573,-0.902,0.415,0.123,-0.904,-0.22,0.368,-0.56,-0.673,-0.483,-0.565,-0.808,0.168,-0.853,-0.51,-0.109,-0.788,0.579,-0.211,-0.738,0.04,-0.673,-0.681,0.421,-0.599,-0.911,0.168,-0.376,-0.325,-0.534,0.78,-0.282,-0.583,0.762,-0.498,-0.583,0.642,-0.329,-0.939,-0.1,-0.221,-0.857,0.465,-0.406,-0.871,0.277,-0.115,0.537,0.836,0.138,-0.194,0.971,-0.353,0.936,-0.019,-0.763,-0.162,0.625,0.392,0.763,0.514,-0.368,-0.51,0.778,-0.482,0.847,-0.225,-0.879,-0.105,0.465,-0.284,-0.608,-0.742,-0.368,-0.833,-0.414,-0.371,-0.253,-0.893,-0.38,-0.559,-0.737,-0.297,0.914,-0.278,-0.389,0.849,-0.358,-0.514,0.834,-0.199,-0.284,0.909,-0.305,-0.45,0.261,-0.854,-0.407,0.611,-0.679,0.224,-0.301,0.927,0.27,-0.472,0.839,0.05,-0.564,0.825,0.339,-0.328,0.882,0.232,-0.799,0.554,-0.076,-0.934,0.348,0.096,-0.994,-0.049,0.064,-0.989,0.137,-0.034,-0.999,-0.031,0.177,0.369,0.913,0.173,0.17,0.97,-0.047,-0.283,0.958,0.265,0.598,0.757,0.02,-0.814,-0.58,-0.251,-0.915,-0.316,0.33,0.781,0.53,0.161,0.974,0.159,0.261,0.911,0.319,-0.141,0.98,-0.143,-0.139,-0.395,-0.908,-0.363,0.063,-0.93,-0.326,0.892,-0.314,-0.472,0.453,-0.757,-0.438,0.726,-0.531,0.575,-0.22,0.788,0.584,-0.517,0.626,0.713,-0.325,0.621,0.517,-0.821,-0.242,0.433,-0.886,0.165,0.873,-0.462,0.154,0.42,0.51,0.75,0.533,0.07,0.843,0.47,0.646,0.602,0.382,-0.586,-0.715,0.279,0.889,0.362,0.088,0.986,0.143,0.198,0.936,0.291,0.177,-0.264,-0.948,-0.113,0.239,-0.964,-0.153,0.988,-0.036,-0.336,0.429,-0.838,-0.305,0.847,-0.435,0.623,0.392,0.677,0.819,-0.166,0.55,0.752,-0.285,-0.594,0.93,-0.307,-0.201,0.884,-0.098,-0.457,0.347,0.883,0.317,0.615,0.715,-0.331,0.583,-0.049,-0.811,0.393,0.396,-0.83,0.747,0.146,-0.648,0.175,0.971,-0.163,0.098,0.766,-0.636,0.069,0.955,-0.287,0.296,0.869,-0.396,0.845,0.381,0.375,0.968,0.131,-0.213,0.986,-0.079,0.145,0.723,0.673,-0.152,0.968,0.248,0.041],[0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1,0.886,0.83,0.556,1],[0,3,1,2,3,0,5,3,6,5,1,3,10,2,7,3,2,10,6,3,10,4,5,6,6,8,4,6,10,8,9,10,7,9,8,10,24,11,22,24,13,11,0,13,24,1,13,0,29,31,23,31,2,23,23,2,24,24,2,0,1,5,13,5,16,13,7,2,31,26,4,28,26,5,4,14,5,26,16,5,14,27,28,33,33,28,4,33,4,8,30,7,31,9,7,30,34,9,30,9,33,8,9,34,33,11,13,12,15,13,16,15,12,13,14,15,16,17,20,18,19,20,17,22,20,24,22,18,20,19,24,20,19,23,24,25,26,28,27,25,28,30,31,29,46,35,45,46,37,35,11,37,46,12,37,11,22,11,46,12,15,37,15,40,37,15,14,40,40,14,49,40,49,43,49,14,26,17,18,21,19,17,21,50,46,44,18,46,50,22,46,18,50,21,18,51,21,50,19,21,51,23,19,51,32,29,53,53,29,23,53,23,51,25,49,26,48,49,25,54,48,25,27,54,25,27,55,54,55,27,57,27,33,57,30,29,32,58,32,56,30,32,58,34,30,58,32,53,56,34,57,33,34,58,57,35,37,36,39,37,40,39,36,37,42,40,43,42,39,40,41,42,43,43,48,41,43,49,48,44,46,45,35,36,38,47,45,65,45,35,65,65,35,66,66,35,38,36,59,38,60,59,36,39,60,36,38,59,66,39,42,63,60,39,63,41,63,42,41,62,63,62,41,48,68,62,48,44,45,47,50,47,52,50,44,47,65,69,47,69,52,47,68,48,54,72,68,54,51,50,52,70,52,69,51,52,70,53,51,70,53,70,56,70,74,56,55,72,54,55,73,72,73,55,75,55,57,75,76,56,74,76,58,56,58,75,57,58,76,75,59,60,61,67,66,77,66,59,77,77,59,78,78,59,61,64,60,63,64,61,60,61,64,78,64,80,78,64,63,62,62,80,64,79,80,62,68,79,62,65,66,67,69,67,71,69,65,67,77,82,67,82,71,67,79,68,72,84,79,72,70,69,71,70,71,74,74,71,82,74,82,87,73,84,72,73,85,84,85,73,88,73,75,88,89,74,87,89,76,74,76,88,75,76,89,88,91,78,93,91,77,78,82,94,83,91,94,82,77,91,82,93,81,92,80,81,93,78,80,93,81,80,79,86,79,84,86,81,79,94,92,83,83,92,81,83,81,86,87,83,90,87,82,83,90,85,88,86,85,90,83,86,90,86,84,85,89,87,90,90,88,89,91,93,95,94,91,95,95,93,92,95,92,94,96,99,97,98,99,96,101,99,102,101,97,99,106,98,103,99,98,106,102,99,106,100,101,102,102,104,100,102,106,104,105,106,103,105,104,106,120,107,118,120,109,107,96,109,120,97,109,96,125,127,119,127,98,119,119,98,120,120,98,96,97,101,109,101,112,109,103,98,127,122,100,124,122,101,100,110,101,122,112,101,110,123,124,129,129,124,100,129,100,104,126,103,127,105,103,126,130,105,126,105,129,104,105,130,129,107,109,108,111,109,112,111,108,109,110,111,112,113,116,114,115,116,113,118,116,120,118,114,116,115,120,116,115,119,120,121,122,124,123,121,124,126,127,125,142,131,141,142,133,131,107,133,142,108,133,107,118,107,142,108,111,133,111,136,133,111,110,136,136,110,145,136,145,139,145,110,122,113,114,117,115,113,117,146,142,140,114,142,146,118,142,114,146,117,114,147,117,146,115,117,147,119,115,147,128,125,149,149,125,119,149,119,147,121,145,122,144,145,121,150,144,121,123,150,121,123,151,150,151,123,153,123,129,153,126,125,128,154,128,152,126,128,154,130,126,154,128,149,152,130,153,129,130,154,153,131,133,132,135,133,136,135,132,133,138,136,139,138,135,136,137,138,139,139,144,137,139,145,144,140,142,141,131,132,134,143,141,161,141,131,161,161,131,162,162,131,134,132,155,134,156,155,132,135,156,132,134,155,162,135,138,159,156,135,159,137,159,138,137,158,159,158,137,144,164,158,144,140,141,143,146,143,148,146,140,143,161,165,143,165,148,143,164,144,150,168,164,150,147,146,148,166,148,165,147,148,166,149,147,166,149,166,152,166,170,152,151,168,150,151,169,168,169,151,171,151,153,171,172,152,170,172,154,152,154,171,153,154,172,171,155,156,157,163,162,173,162,155,173,173,155,174,174,155,157,160,156,159,160,157,156,157,160,174,160,176,174,160,159,158,158,176,160,175,176,158,164,175,158,161,162,163,165,163,167,165,161,163,173,178,163,178,167,163,175,164,168,180,175,168,166,165,167,166,167,170,170,167,178,170,178,183,169,180,168,169,181,180,181,169,184,169,171,184,185,170,183,185,172,170,172,184,171,172,185,184,187,174,189,187,173,174,178,190,179,187,190,178,173,187,178,189,177,188,176,177,189,174,176,189,177,176,175,182,175,180,182,177,175,190,188,179,179,188,177,179,177,182,183,179,186,183,178,179,186,181,184,182,181,186,179,182,186,182,180,181,185,183,186,186,184,185,187,189,191,190,187,191,191,189,188,191,188,190,192,195,193,194,195,192,197,195,198,197,193,195,202,194,199,195,194,202,198,195,202,196,197,198,198,200,196,198,202,200,201,202,199,201,200,202,216,203,214,216,205,203,192,205,216,193,205,192,221,223,215,223,194,215,215,194,216,216,194,192,193,197,205,197,208,205,199,194,223,218,196,220,218,197,196,206,197,218,208,197,206,219,220,225,225,220,196,225,196,200,222,199,223,201,199,222,226,201,222,201,225,200,201,226,225,203,205,204,207,205,208,207,204,205,206,207,208,209,212,210,211,212,209,214,212,216,214,210,212,211,216,212,211,215,216,217,218,220,219,217,220,222,223,221,238,227,237,238,229,227,203,229,238,204,229,203,214,203,238,204,207,229,207,232,229,207,206,232,232,206,241,232,241,235,241,206,218,209,210,213,211,209,213,242,238,236,210,238,242,214,238,210,242,213,210,243,213,242,211,213,243,215,211,243,224,221,245,245,221,215,245,215,243,217,241,218,240,241,217,246,240,217,219,246,217,219,247,246,247,219,249,219,225,249,222,221,224,250,224,248,222,224,250,226,222,250,224,245,248,226,249,225,226,250,249,227,229,228,231,229,232,231,228,229,234,232,235,234,231,232,233,234,235,235,240,233,235,241,240,236,238,237,227,228,230,239,237,257,237,227,257,257,227,258,258,227,230,228,251,230,252,251,228,231,252,228,230,251,258,231,234,255,252,231,255,233,255,234,233,254,255,254,233,240,260,254,240,236,237,239,242,239,244,242,236,239,257,261,239,261,244,239,260,240,246,264,260,246,243,242,244,262,244,261,243,244,262,245,243,262,245,262,248,262,266,248,247,264,246,247,265,264,265,247,267,247,249,267,268,248,266,268,250,248,250,267,249,250,268,267,251,252,253,259,258,269,258,251,269,269,251,270,270,251,253,256,252,255,256,253,252,253,256,270,256,272,270,256,255,254,254,272,256,271,272,254,260,271,254,257,258,259,261,259,263,261,257,259,269,274,259,274,263,259,271,260,264,276,271,264,262,261,263,262,263,266,266,263,274,266,274,279,265,276,264,265,277,276,277,265,280,265,267,280,281,266,279,281,268,266,268,280,267,268,281,280,283,270,285,283,269,270,274,286,275,283,286,274,269,283,274,285,273,284,272,273,285,270,272,285,273,272,271,278,271,276,278,273,271,286,284,275,275,284,273,275,273,278,279,275,282,279,274,275,282,277,280,278,277,282,275,278,282,278,276,277,281,279,282,282,280,281,283,285,287,286,283,287,287,285,284,287,284,286]],
["vp",830,551,114.237,191.524]
]
/*
 * Copyright (c) 1989-2011 The Regents of the University of California.
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms are permitted
 * provided that the above copyright notice and this paragraph are
 * duplicated in all such forms and that any documentation,
 * advertising materials, and other materials related to such
 * distribution and use acknowledge that the software was developed
 * by the University of California, San Francisco.  The name of the
 * University may not be used to endorse or promote products derived
 * from this software without specific prior written permission.
 * THIS SOFTWARE IS PROVIDED ``AS IS'' AND WITHOUT ANY EXPRESS OR
 * IMPLIED WARRANTIES, INCLUDING, WITHOUT LIMITATION, THE IMPLIED
 * WARRANTIES OF MERCHANTIBILITY AND FITNESS FOR A PARTICULAR PURPOSE.
 *
 * $Id: vsphere.c,v 1.3 89/11/09 15:45:26 conrad Exp $
 */
/*
 * vsphere:
 *	Convert X-Y coordinates into a 4x4 rotation matrix
 */
function vsphere(fxy, txy)
{
	var	i;
	var	d1, d2;
	var	f, t, a, g, u;
	var	m1, m2;

	/*
	 * First construct the unit vectors and computing
	 * the normal unit vectors.  If we cross from outside
	 * the sphere to inside the sphere (or vice versa), then
	 * we ignore the transition because the discontinuity
	 * tends to make molecules jump.
	 */
	d1 = fxy.x * fxy.x + fxy.y * fxy.y;
	d2 = txy.x * txy.x + txy.y * txy.y;
	if (d1 > 1 && d2 < 1)
		throw "outside to inside";
	if (d2 > 1 && d1 < 1)
		throw "inside to outside";
	if (d1 < 1) {
		f = new Vec3(fxy.x, fxy.y, Math.sqrt(1 - d1));
	} else {
		d1 = Math.sqrt(d1);
		f = new Vec3(fxy.x / d1, fxy.y / d1, 0);
	}
	if (d2 < 1) {
		t = new Vec3(txy.x, txy.y, Math.sqrt(1 - d2));
	} else {
		d2 = Math.sqrt(d2);
		t = new Vec3(txy.x / d2, txy.y / d2, 0);
	}

	/*
	 * If the positions normalize to the same place we just punt.
	 * We don't even bother to put in the identity matrix.
	 */
	if (f[0] == t[0] && f[1] == t[1] && f[2] == t[2])
		throw "no change";

	a = f.cross(t);
	a.$unit();
	var m;
	g = a.cross(f);		/* Don't need to normalize these since the */
	u = a.cross(t);		/* cross product of normal unit vectors is */
				/* a unit vector */

	/*
	 * Now assemble them into the inverse matrix (to go from
	 * the from-vector to xyz-space) and the transform matrix
	 * (to go from xyz-space to to-vector).  The product of
	 * the inverse and transformation matrices is the rotation
	 * matrix.
	 */
	m1 = new Mat4(	t[0], a[0], u[0], 0,
			t[1], a[1], u[1], 0,
			t[2], a[2], u[2], 0,
			0, 0, 0, 1);
	m2 = new Mat4(	f[0], f[1], f[2], 0,
			a[0], a[1], a[2], 0,
			g[0], g[1], g[2], 0,
			0, 0, 0, 1);
	m = m1.mulMat4(m2);
	return m;
}
// Copyright © 2011 Regents of the University of California.
// All rights reserved.  This software provided pursuant to a
// license agreement containing restrictions on its disclosure,
// duplication and use.  This notice must be embedded in or
// attached to all copies, including partial copies, of the
// software or any revisions or derivations thereof.
//
'use strict';
// vi: sw=2:

function webGLStart() {
  var mouse_position;
  var canvas_name = 'molview';

  if (!PhiloGL.hasWebGL()) {
    return;
  }

  // from http://paulirish.com/2011/requestanimationframe-for-smart-animating/
  // shim layer with setTimeout fallback
  window.requestAnimFrame = (function() {
    return window.requestAnimationFrame
    || window.webkitRequestAnimationFrame
    || window.mozRequestAnimationFrame
    || window.oRequestAnimationFrame
    || window.msRequestAnimationFrame
    || function(/* function */ callback, /* DOMElement */ element) {
	 window.setTimeout(callback, 0);
       };
  })();

  // from http://www.jspatterns.com/category/patterns/code-reuse/
  function inherit(ChildClass, ParentClass) {
    var Chain = function () {};
    Chain.prototype = ParentClass.prototype;
    ChildClass.prototype = new Chain();
    ChildClass.prototype.constructor = ChildClass;
  }

  // grab some utility functions from PhiloGL
  function $() {};

  $.extend = function (to, from) {
    for (var p in from) {
      to[p] = from[p];
    }
    return to;
  };

  $.type = (function () {
    var oString = Object.prototype.toString,
	type = function (e) {
	  var t = oString.call(e);
	  return t.substr(8, t.length - 9).toLowerCase();
	};

    return function (elem) {
      var elemType = type(elem);
      if (elemType != 'object') {
	return elemType;
      }
      if (elem.$$family) return elem.$$family;
      return (elem && elem.nodeName && elem.nodeType == 1) ? 'element' : elemType;
    };
  })();

  (function () {
    function detach(elem) {
      var type = $.type(elem), ans;
      if (type == 'object') {
	ans = {};
	for (var p in elem) {
	  ans[p] = detach(elem[p]);
	}
	return ans;
      } else if (type == 'array') {
	ans = [];
	for (var i = 0, l = elem.length; i < l; i++) {
	  ans[i] = detach(elem[i]);
	}
	return ans;
      } else {
	return elem;
      }
    }

    $.merge = function () {
      var mix = {};
      for (var i = 0, l = arguments.length; i < l; i++){
	  var object = arguments[i];
	  if ($.type(object) != 'object') continue;
	  for (var key in object){
	      var op = object[key], mp = mix[key];
	      if (mp && $.type(op) == 'object' && $.type(mp) == 'object') {
		mix[key] = $.merge(mp, op);
	      } else{
		mix[key] = detach(op);
	      }
	  }
      }
      return mix;
    };
  })();

  PhiloGL.unpack();

  // create Spheres subclass of O3D.Model

  function Spheres(opt) {
    opt = $.merge({
      program: 'offset'
    }, opt || {});
    O3D.Model.call(this, opt);
    this.ProtoSpheres = {};
    this.spheres = {}
    this.render = Spheres.prototype.render;
  }

  inherit(Spheres, O3D.Model);

  $.extend(Spheres.prototype, {
      // disable normal object methods and do everything in render method
      setUniforms: function () {},
      setAttributes: function () {},
      setShininess: function () {},
      setReflection: function () {},
      setVertices: function () {},
      setColors: function () {},
      setPickingColors: function () {},
      setNormals: function () {},
      setTextures: function () {},
      setTexCoords: function () {},
      setIndices: function () {},
      unsetAttributes: function () {},
      unsetVertices: function () {},
      unsetColors: function () {},
      unsetPickingColors: function () {},
      unsetNormals: function () {},
      unsetTexCoords: function () {},
      unsetIndices: function () {},

      add: function (scene, radius, position, color) {
	var sphere = this.ProtoSpheres[radius];
	if (sphere == undefined) {
	  sphere = new O3D.Sphere({
	    radius: radius, nlat: 10, nlong: 10,
	    program: 'offset'
	  });
	  this.ProtoSpheres[radius] = sphere;
	  sphere.id = "sphere-" + radius;
	  scene.defineBuffers(sphere);
	}
	var data = this.spheres[radius];
	if (data == undefined) {
	  data = this.spheres[radius] = [];
	}
	data.push([position, color]);
      },

      render: function (gl, program, camera) {
	var offset = program.attributes['offset'];
	var color = program.attributes['color'];
	var obj;
	for (var radius in this.spheres) {
	  obj = this.ProtoSpheres[radius];
	  obj.setUniforms(program);
	  obj.setAttributes(program);
	  obj.setShininess(program);
	  obj.setReflection(program);
	  obj.setVertices(program);
	  obj.setColors(program);
	  obj.setPickingColors(program);
	  obj.setNormals(program);
	  obj.setTextures(program);
	  obj.setTexCoords(program);
	  obj.setIndices(program);

	  var data = this.spheres[radius];
	  for (var i = 0, l = data.length; i < l; ++i) {
	    gl.vertexAttrib3fv(offset, data[i][0]);
	    gl.vertexAttrib4fv(color, data[i][1]);
	    if (obj.indices) {
	      gl.drawElements((obj.drawType !== undefined)
			  ? gl.get(obj.drawType) : gl.TRIANGLES,
		  obj.indices.length, gl.UNSIGNED_SHORT, 0);
	    } else {
	      gl.drawArrays((obj.drawType !== undefined)
			  ? gl.get(obj.drawType) : gl.TRIANGLES,
		  0, obj.vertices.length / 3);
	    }
	  }

	  obj.unsetAttributes(program);
	  obj.unsetVertices(program);
	  obj.unsetColors(program);
	  obj.unsetPickingColors(program);
	  obj.unsetNormals(program);
	  obj.unsetTexCoords(program);
	  obj.unsetIndices(program);
	}
      },
  });

  // create Cylinder subclass of O3D.Model

  function Cylinders(opt) {
    opt = $.merge({
      program: 'cylinder'
    }, opt || {});
    O3D.Model.call(this, opt);
    this.ProtoCylinders = {};
    this.cylinders = {}
    this.render = Cylinders.prototype.render;
  }

  inherit(Cylinders, O3D.Model);

  $.extend(Cylinders.prototype, {
      // disable normal object methods and do everything in render method
      setUniforms: function () {},
      setAttributes: function () {},
      setShininess: function () {},
      setReflection: function () {},
      setVertices: function () {},
      setColors: function () {},
      setPickingColors: function () {},
      setNormals: function () {},
      setTextures: function () {},
      setTexCoords: function () {},
      setIndices: function () {},
      unsetAttributes: function () {},
      unsetVertices: function () {},
      unsetColors: function () {},
      unsetPickingColors: function () {},
      unsetNormals: function () {},
      unsetTexCoords: function () {},
      unsetIndices: function () {},

      add: function (scene, radius, height, mat4x3, color) {
	var cylinder = this.ProtoCylinders[radius];
	if (cylinder == undefined) {
	  cylinder = new O3D.Cylinder({
	    radius: radius, nvertical: 2, nradial: 10,
	    program: 'cylinder'
	  });
	  this.ProtoCylinders[radius] = cylinder;
	  cylinder.id = "cylinder-" + radius;
	  scene.defineBuffers(cylinder);
	}
	var data = this.cylinders[radius];
	if (data == undefined) {
	  data = this.cylinders[radius] = [];
	}
	data.push([height, mat4x3, color]);
      },

      render: function (gl, program, camera) {
	var yscale = program.attributes['yscale'];
	var transformX = program.attributes['transformX'];
	var transformY = program.attributes['transformY'];
	var transformZ = program.attributes['transformZ'];
	var color = program.attributes['color'];
	var obj;
	for (var radius in this.cylinders) {
	  obj = this.ProtoCylinders[radius];
	  obj.setUniforms(program);
	  obj.setAttributes(program);
	  obj.setShininess(program);
	  obj.setReflection(program);
	  obj.setVertices(program);
	  obj.setColors(program);
	  obj.setPickingColors(program);
	  obj.setNormals(program);
	  obj.setTextures(program);
	  obj.setTexCoords(program);
	  obj.setIndices(program);

	  var data = this.cylinders[radius];
	  for (var i = 0, l = data.length; i < l; ++i) {
	    gl.vertexAttrib1f(yscale, data[i][0]);
	    gl.vertexAttrib4fv(transformX, data[i][1][0]);
	    gl.vertexAttrib4fv(transformY, data[i][1][1]);
	    gl.vertexAttrib4fv(transformZ, data[i][1][2]);
	    gl.vertexAttrib4fv(color, data[i][2]);
	    if (obj.indices) {
	      gl.drawElements((obj.drawType !== undefined)
			  ? gl.get(obj.drawType) : gl.TRIANGLES,
		  obj.indices.length, gl.UNSIGNED_SHORT, 0);
	    } else {
	      gl.drawArrays((obj.drawType !== undefined)
			  ? gl.get(obj.drawType) : gl.TRIANGLES,
		  0, obj.vertices.length / 3);
	    }
	  }

	  obj.unsetAttributes(program);
	  obj.unsetVertices(program);
	  obj.unsetColors(program);
	  obj.unsetPickingColors(program);
	  obj.unsetNormals(program);
	  obj.unsetTexCoords(program);
	  obj.unsetIndices(program);
	}
      },
  });

  function buildScene(app, json) {
    var gl = app.gl;
    var camera = app.camera;
    var scene = app.scene;
    var lights = scene.config.lights;
    var seenLight = false;
    var index;
    var spheres, cylinders;
    var model;
	camera.wheelScale = 1;
    for (index in json) {
      var item = json[index];
      switch (item[0]) {
      case 's': // sphere
	if (!spheres) {
	  spheres = new Spheres;
	  scene.add(spheres);
	}
	spheres.add(scene, item[1], item[2], item[3]);
	break;
      case 'c': // cylinder
	if (!cylinders) {
	  cylinders = new Cylinders;
	  scene.add(cylinders);
	}
	cylinders.add(scene, item[1], item[2], item[3], item[4]);
	break;
      case 'p':
	model = new O3D.Model({
	  program: 'nolight',
	  drawType: "POINTS",
	  vertices: item[1],
	  colors: item[2]
	});
	scene.add(model);
	break;
      case 'l':
	model = new O3D.Model({
	  program: 'nolight',
	  drawType: "LINES",
	  vertices: item[1],
	  colors: item[2]
	});
	scene.add(model);
	break;
      case 'il':
	model = new O3D.Model({
	  program: 'nolight',
	  drawType: "LINES",
	  vertices: item[1],
	  colors: item[2],
	  indices: item[3]
	});
	scene.add(model);
	break;
      case 't':
      case 'ts':
	model = new O3D.Model({
	  program: 'default',
	  drawType: (item[0] == 't') ? "TRIANGLES" : "TRIANGLE_STRIP",
	  vertices: item[1],
	  normals: item[2],
	  colors: item[3],
	  indices: item[4]
	});
	scene.add(model);
	break;
      case 'bg': // background color
	gl.clearColor(item[1], item[2], item[3], 1);
	break;
      case 'vp': { // viewport
	  var canvas = app.canvas;
	  canvas.width = item[1];
	  canvas.height = item[2];
	  camera.near = item[3];
	  camera.far = item[4];
	  camera.aspect = item[1] / item[2];
	  camera.wheelScale = camera.near / 5;
	  if (camera.type == 'ortho') {
	    // figure out fov
	    camera.fov = Math.atan(camera.orthoParams[3] / camera.near) * 360 / Math.PI;
	  }
	};
	break;
      case 'la': // ambient light
	if (!seenLight) {
	  lights.enable = true;
	  lights.ambient = { r: 0, g: 0, b: 0 };
	  lights.directional = {
	    color: { r: 0, g: 0, b: 0 },
	    direction: { x: item[4], y: item[5], z: item[6] }
	  };
	  lights.points = [];
	  seenLight = true;
	};
	lights.ambient.r += item[1]
	lights.ambient.g += item[2]
	lights.ambient.b += item[3]
	break;
      case 'ld': // directional light
	if (!seenLight) {
	  lights.enable = true;
	  lights.ambient = { r: 0, g: 0, b: 0 };
	  lights.directional = {
	    color: { r: 0, g: 0, b: 0 },
	    direction: { x: item[4], y: item[5], z: item[6] }
	  };
	  lights.points = [];
	  seenLight = true;
	}
	var p = camera.target;
	var dir = new Vec3(-item[4], -item[5], -item[6]);
	dir.$scale(p.sub(camera.position).norm());
	lights.points.push({
	  diffuse: { r: item[1], g: item[2], b: item[3] },
	  specular: { r: 1.0, g: 1.0, b: 1.0 },
	  position: p.add(dir.scale(10))
	});
	break;
      case 'eyepos': // eye postion (look at eye position)
	camera.position = new Vec3(item[1], item[2], item[3]);
	break;
      case 'up': // up vector (look at up direction)
	camera.up = new Vec3(item[1], item[2], item[3]);
	break;
      case 'cofr': // center of rotation (look at point)
	camera.target = new Vec3(item[1], item[2], item[3]);
	break;
      case 'ortho': // orthographic viewpoint
	camera.type = 'ortho';
	camera.orthoParams = [item[1], item[2], item[3], item[4]]
	break;
      case 'persp': // perspective viewpoint
	camera.fov = item[1];
	break;
      }
    }
    camera.update();
  }

  function loadJSON(url, app) {
    new IO.XHR({
      url: url,
      onSuccess: function (text) {
	var json = JSON.parse(text);
	buildScene(app, json);
      }
    }).send();
    /*
    console.log('call JSONP');
    IO.JSONP({
      url: url,
      callbackKey: 'loadModel',
      onComplete: function(json) {
        console.log(json);
	buildScene(app, json);
      }
    });
    */
  }

  function draw(app) {
    var gl = app.gl,
	scene = app.scene,
	canvas = app.canvas;
    gl.viewport(0, 0, +canvas.width, +canvas.height);
    gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
    scene.render();
  }

  //Create application
  new PhiloGL(canvas_name, {
    program: [{
      id: 'default',
      from: 'defaults',
      vs: 'Default',
      fs: 'Default'
    },{
      id: 'offset',
      from: 'ids',
      vs: 'offset.vs',
      fs: 'default.fs',
      noCache: true		// TODO: false for production version
    },{
      id: 'cylinder',
      from: 'ids',
      vs: 'cylinder.vs',
      fs: 'default.fs',
    },{
      id: 'nolight',
      from: 'ids',
      vs: 'nolight.vs',
      fs: 'default.fs',
    }],
    /*
    context: {
      debug: true
    },
    */
    camera: {
      position: {
        x: 0, y: 0, z: -7
      }
    },
    events: {
      onDragStart: function (e) {
	var canvas = this.canvas;
	var radius = 0.9 * 0.5 * Math.min(canvas.width, canvas.height);
	mouse_position = {
	  x: e.x / radius,
	  y: e.y / radius
	};
      },
      onDragMove: function (e) {
	var canvas = this.canvas;
	var radius = 0.9 * 0.5 * Math.min(canvas.width, canvas.height);
	var new_position = {
	  x: e.x / radius,
	  y: e.y / radius
	};
	try {
	  var rotMat = vsphere(mouse_position, new_position);
	  var camera = this.camera;
	  var matrix = new Mat4;
	  matrix.$translate(camera.target[0], camera.target[1],
	    camera.target[2]);
	  matrix.$mulMat4(rotMat);
	  matrix.$translate(-camera.target[0], -camera.target[1],
	    -camera.target[2]);
	  for (var i = 0, models = this.scene.models, l = models.length; i < l; ++i) {
	    var elem = models[i];
	    elem.matrix = matrix.mulMat4(elem.matrix);
	  }
	} catch (err) {
	}
        mouse_position = new_position;
	var self = this;
	requestAnimFrame(function () { draw(self); });
      },
      onMouseWheel: function (e) {
        e.stop();
        var camera = this.camera;
	adjust = e.wheel * camera.wheelScale;
	if (camera.near + adjust > 0) {
	  camera.position.z += adjust;
	  camera.near += adjust;
	  camera.far += adjust;
	}
        camera.update();
	var self = this;
	requestAnimFrame(function () { draw(self); });
      }
    },
    onError: function (info) {
      alert("There was an error creating the app. " + info);
    },
    onLoad: function (app) {
      //Unpack app properties
      //app.gl = WebGLDebugUtils.makeDebugContext(app.gl);
      var gl = app.gl,
          scene = app.scene,
          canvas = app.canvas;

      var DEBUG_COUNT = 0;		// 0 to disable

      //Basic gl setup
      gl.clearColor(0.0, 0.0, 0.0, 1.0);
      gl.clearDepth(1.0);
      gl.enable(gl.DEPTH_TEST);
      gl.depthFunc(gl.LEQUAL);

      //Add objects to the scene
      //loadJSON('/gregc/one-cpk.json', app)
      //loadJSON('/gregc/mtx-cpk.json', app)
      //loadJSON('/gregc/3k9f-cpk.json', app)
      buildScene(app, json);

      requestAnimFrame(function () { draw(app); });
    }
  });
}
</script>
